<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>GPT Cataloging Assistant</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #f8f9fa;
      padding: 20px;
    }
    #dropZone {
      border: 2px dashed #ccc;
      padding: 30px;
      text-align: center;
      background: #fff;
      margin-bottom: 10px;
      cursor: pointer;
    }
    textarea, button {
      width: 100%;
      margin-top: 10px;
      padding: 10px;
    }
    #result {
      white-space: pre-wrap;
      background: #eef;
      padding: 10px;
      margin-top: 10px;
    }
  </style>
</head>
<body>
  <h2>üìö GPT Cataloging Assistant</h2>

  <!-- Hidden file input -->
  <input type="file" id="fileInput" multiple accept=".pdf,.txt" style="display: none;" />

  <!-- Clickable + drag-and-drop area -->
  <div id="dropZone" onclick="document.getElementById('fileInput').click();">
    üì• Click or Drag and Drop PDF/TXT files here
  </div>

  <textarea id="instructions" rows="3" placeholder="Write instructions or extra notes here..."></textarea>
  <button onclick="sendToGPT()">Send to GPT</button>
  <div id="status">üü° Waiting...</div>
  <div id="result">Result will appear here...</div>
  <button onclick="exportResult('mrk')">‚¨áÔ∏è Export as .mrk</button>
  <button onclick="exportResult('json')">‚¨áÔ∏è Export as .json</button>
  <button onclick="exportResult('xml')">‚¨áÔ∏è Export as .xml</button>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.12.313/pdf.min.js"></script>
  <script>
    let extractedText = "";

    // Drag and drop
    const dropZone = document.getElementById("dropZone");
    dropZone.addEventListener("dragover", e => {
      e.preventDefault();
      dropZone.style.borderColor = "blue";
    });
    dropZone.addEventListener("dragleave", e => {
      e.preventDefault();
      dropZone.style.borderColor = "#ccc";
    });
    dropZone.addEventListener("drop", e => {
      e.preventDefault();
      dropZone.style.borderColor = "#ccc";
      const files = [...e.dataTransfer.files];
      processFiles(files);
    });

    // Click-to-upload
    document.getElementById("fileInput").addEventListener("change", e => {
      const files = [...e.target.files];
      processFiles(files);
    });

    // Handle all files
    function processFiles(files) {
      files.forEach(file => {
        if (file.type === "application/pdf") extractFromPDF(file);
        else if (file.type === "text/plain") extractFromTXT(file);
      });
    }

    async function extractFromPDF(file) {
      const reader = new FileReader();
      reader.onload = async () => {
        const pdf = await pdfjsLib.getDocument(new Uint8Array(reader.result)).promise;
        let text = "";
        for (let i = 1; i <= pdf.numPages; i++) {
          const page = await pdf.getPage(i);
          const content = await page.getTextContent();
          text += content.items.map(item => item.str).join(" ") + "\\n";
        }
        extractedText += `\\n--- ${file.name} ---\\n` + text;
        document.getElementById("status").innerText = "‚úÖ Text ready to send.";
      };
      reader.readAsArrayBuffer(file);
    }

    function extractFromTXT(file) {
      const reader = new FileReader();
      reader.onload = () => {
        extractedText += `\\n--- ${file.name} ---\\n` + reader.result;
        document.getElementById("status").innerText = "‚úÖ Text ready to send.";
      };
      reader.readAsText(file);
    }

    async function sendToGPT() {
      const notes = document.getElementById("instructions").value;
      const fullText = extractedText + "\\n\\n" + notes;
      document.getElementById("status").innerText = "‚è≥ Sending to GPT...";
      try {
        const response = await fetch("/catalog", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ text: fullText })
        });
        const data = await response.json();
        document.getElementById("result").innerText = data.result || data.error || "No result.";
        document.getElementById("status").innerText = "‚úÖ Done.";
      } catch (e) {
        document.getElementById("status").innerText = "‚ùå Error sending to server.";
      }
    }

    function exportResult(format) {
      const text = document.getElementById("result").textContent;
      const blob = new Blob([text], { type: "text/plain;charset=utf-8" });
      const a = document.createElement("a");
      a.href = URL.createObjectURL(blob);
      a.download = "catalog_result." + format;
      a.click();
    }
  </script>
</body>
</html>
